@(chart: String)
@import web.controllers.Localize
function toggleSub(e) {
	var sub = e.next();
	sub.slideToggle(200);
	sub.find(".selected").removeClass("selected");
	sub.find(".sub").hide();
}
//check all requirements and send ajax request for chart
function makeRequest() {
	var time = checkBuildTime();
	if(time != "err" && checkOptions()){
		var json = buildJson();
		json.time = time;
		$.ajax({
			type: "POST",
			url: "/requestChart",
			data: JSON.stringify(json),
			processData: false,
			//send type
			contentType: "application/json; charset=UTF-8",
			//expected result type
			dataType: "json",
			//display ajax loader
			beforeSend: function() {
				$("#chart").append("<div id='loader'></div>");
				$("#chart")[0].scrollIntoView(true);
			},
			success:function(data) {
		  		@{chart}(data);
			},
			error:function(q, err, ex) {
				$("#chart").html("");
		 		displayError("@Localize.get("charts.requestErr")");
			}
		});
	//if error
	} else {
		$("#chart").html("");
	}
}
//check wether all requirements for a successful chart request are met
function checkOptions() {
	var errOp = [];
	//check wether value for x axis is selected
	if ($("#x").length == 1 && $("#x").find(".sub:visible").children(".selected").length != 1) {
		errOp.push($("#x").children(":first"));
	}
	//check also y
	if ($("#y").length == 1 && $("#y").find(".sub:visible").children(".selected").length != 1) {
		errOp.push($("#y").children(":first"));
	}
	//check wether a measure is selected
	if ($("#measures").find(".sub").children(".selected").length == 0) {
		errOp.push($("#measures").children(":first"));
	}
	//remove old marked fields
	$(".required").css("background-color", "lightgray");
	$(".required").removeClass("required");
	//if not all correct
	if(errOp.length != 0) {
		var info = "";
		$(errOp).each(function(i) {
			info += $(this).html() + "<br />";
			//make required fields red
			$(this).addClass("required");
			$(this).css("background-color", "#FF7777");
		});
		displayError("@Localize.get("filter.err")" ,info);
		return false;
	//if everything correct
	} else {
		return true;
	}
}

//check if period of time chosen is correct and build json object of it
function checkBuildTime() {
	// 0:year, 1: month, 2: day, 3: hour
	var tF = [];
	var tT = [];
	var tmp = $("#yearFrom").html();
	if(tmp != "&nbsp;" && tmp != "---") { tF.push(parseInt(tmp)); }
	tmp = $("#yearTo").html();
	if(tmp != "&nbsp;" && tmp != "---") { tT.push(parseInt(tmp)); }
	tmp = $("#monthFrom").html();
	if(tmp != "&nbsp;" && tmp != "---") { tF.push(parseInt(tmp)); }
	tmp = $("#monthTo").html();
	if(tmp != "&nbsp;" && tmp != "---") { tT.push(parseInt(tmp)); }
	tmp = $("#dayFrom").val();
	if(tmp != "") { tF.push(parseInt(tmp)); }
	tmp = $("#dayTo").val();
	if(tmp != "") { tT.push(parseInt(tmp)); }
	tmp = $("#hourFrom").val();
	if(tmp != "") { tF.push(tmp); }
	tmp = $("#hourTo").val();
	if(tmp != "") { tT.push(tmp); }
	//checks begin
	if(tF.length != tT.length) { displayError("@Localize.get("time.err.argLength")"); return "err"; }
	//if no args return all
	if(tF.length == 0) { return "all"; }
	//if yearFrom > yearTo --> error
	if(tF[0] > tT[0]) { displayError("@Localize.get("time.err.negativeTime")"); return "err"; }
	//if years equal, months exist and monthFrom > monthTo --> error
	else if(tF.length > 1 && tF[0] == tT[0] && tF[1] > tT[1]) { displayError("@Localize.get("time.err.negativeTime")"); return "err"; }
	//if days exist
	else if(tF.length > 2) {
		//check if # of days exist in the respective month, else --> error
		if(daysOfMonth(tF[0], tF[1]) < tF[2] || daysOfMonth(tT[0], tT[1]) < tT[2] 
			|| tF[2] < 1 || tT[2] < 1) { displayError("@Localize.get("time.err.monthsDays")"); return "err"; }
		//if months are the same, check if dayFrom < dayTo, else --> error
		if(tF[1] == tT[1] && tF[2] > tT[2]) { displayError("@Localize.get("time.err.negativeTime")"); return "err"; }
		//if hours exist
		if (tF.length > 3) {
			//check if times of the day exist, else --> error
			tF[3] = makeTime(tF[3]);
			tT[3] = makeTime(tT[3]);
			//test if parsing hours was correct, else --> error
			if(tF[3] == "err" || tT[3] == "err") { displayError("@Localize.get("time.err.wrongHour")"); return "err"; }
			//if days are the same, check if hoursFrom < hoursTo
			if(tF[2] == tT[2] && tF[3][0] > tT[3][0]) { displayError("@Localize.get("time.err.negativeTime")"); return "err"; }
			//if hours are the same, check if minFrom < minTo
			if(tF[3][0] == tT[3][0] && tF[3][1] > tT[3][1]) { displayError("@Localize.get("time.err.negativeTime")"); return "err"; }
		}
	}
	 
	//completed checks ! build time object
	var time = {}
	//exist because all has already returned
	time.years = [tF[0], tT[0]];
	//if months exist
	if(tF.length > 1) { time.months = [tF[1], tT[1]]; }
	//if days exist
	if(tF.length > 2) { time.days = [tF[2], tT[2]]; }
	//if hours & minutes exist
	if(tF.length > 3) { 
		time.hours = [tF[3][0], tT[3][0]];
		time.mins = [tF[3][1], tT[3][1]];
	}
	return time;
}

//check how many days a month of the year has
function daysOfMonth(year, month) { return new Date(year,month,0).getDate(); }
//check wether times of day are correct
function makeTime(time) {
	var timePat = new RegExp("(^[0-9]|^[1][0-9]|^[2][1-3]):[0-5][0-9]$");
	//if it is not a time --> error
	if(!timePat.test(time)) { return "err"; }
	//else return array with hours and minutes
	return [parseInt(time.substring(0,time.length-3)), parseInt(time.substr(time.length-2,2))];
}

//assumes that all values needed are selected
function buildJson() {
	//empty js object
	var json = {}
	//save chartName
	json.chart = "@{chart}";
	//save dim selected as x in object
	var xSel = $("#x").find(".sub").children(".selected");
	json.x = xSel.attr("data");
	json.xDim = xSel.parent().prev().attr("data");
	//if y exists add it
	var y = $("#y");
	if(y.length == 1) {
		var ySel = $("#y").find(".sub").children(".selected");
		json.y = ySel.attr("data");
		json.yDim = ySel.parent().prev().attr("data");
	}
	//save selected filter
	json.filter = [];
	$(".dim").parent().each(function(i) {
		var id = $(this).attr("id");
		if($(this).find(".selected").length > 0 && id != json.xDim && id != json.yDim) {
			json.filter.push($(this).attr("id"));
		}
	});
	//save all selected options in object
	var options = $(".options");
	for(var i = 0; i < options.length; i++) {
		var op = $(options[i]);
		//if option is dim build a tree with selected
		if(op.children(".list").hasClass("dim")) {
			var li = op.children(".list");
			var selected = li.children(".selected");
			var lvl = {};
			lvl.level = li.attr("data");
			//if nothing selected --> all
			if (selected.length == 0) {
				lvl.selected = "all";
			//else build array, recursively if needed
			} else {
				 lvl.selected = buildTree(selected);
			}
			json[op[0].id] = lvl;
		// if it is a measure save selected measure
		} else if(op.attr("id") == "measures"){
			var sel = op.find(".sub").children(".selected");
			//look in data attribute, if not found, take text
			json.measure = sel.parent().prev().attr("data");
			json.aggregation = sel.attr("data");
		}
	}
	return json;
}

//build a tree with all selected values of a dimension
function buildTree(lvl) {
	var arr = [];
	for(var i = 0; i < lvl.length; i++) {
		var el = $(lvl[i]);
		//el has sub dimensions 
		if(el.next().hasClass("sub") && el.next().children(".selected").length != 0) {
			var obj = {};
			obj.level = el.next().attr("data");
			obj.parent = el.html();
			obj[el.html()] = buildTree(el.next().children(".selected"));
			arr.push(obj);
		//el has no sub dimension and can be added itself	
		} else {
			arr.push(el.html());
		}
	}
	return arr;
}

//ready function called when DOM is ready
$(document).ready(function() {
	//hide time spans
	$(".dropdown").hide();
	//register click function for dropdowns
	$(".dropdown").prev().click(function() {
		$(this).next().slideToggle(200);
	});
	$(".dropdown").children().click(function() {
		var drop = $(this).parents(".dropdown");
		drop.prev().html($(this).html());
		drop.slideToggle(200);
	});
	//hide all subsections
	$(".sub").hide();
	//register click function to all options
	$(".options").find("span").click(function() {
		var parent = $(this).parent();
		var single = $(this).parents(".single");
		//if the clicked option has sub selections
		if($(this).next().hasClass('sub')) {
			$(this).toggleClass("selected");
			toggleSub($(this));
		//if only one option can be selected in this group
		} else if (parent.hasClass("group")) {
			if(!$(this).hasClass("selected")) {
				parent.children(".selected").removeClass("selected");
			}
			$(this).toggleClass("selected");
		//if no single selection
		} else if (single.length == 0){ 
			$(this).toggleClass("selected");
		}
		//if single selection
		if (single.length > 0 && parent.hasClass("sub")) {
			if(!$(this).hasClass("selected")) {
				single.find(".sub:visible").children(".selected").removeClass("selected");
			}
			$(this).toggleClass("selected");
		}
	});
	//register click function for chart request
	$("#send").click(makeRequest);
	//register click function for save button
	$("#save").click(displaySave);
	
	//add chart js
	$("head").append('<script type="text/javascript" src="/charts/@{chart}/@{chart}.js"></script>');
	@if(web.ChartIndex.getInstance().hasCss(chart)) {
	//add chart css
	$("head").append('<link href="/charts/@{chart}/@{chart}.css" rel="stylesheet" type="text/css">');
	}
	//add chart div
	$("<div id=\"chart\"></div>").insertBefore("#content");
	
	//check url for history hash and make history request if needed
	if(new RegExp("#hist=[0-9]{1,2}").test($(location).attr("hash"))) {
		var obj = {};
		obj["hist"] = parseInt($(location).attr("hash").substring(6));
		$.ajax({
			url: "/requestHistory",
			data: obj,
			//expected result type
			dataType: "json",
			//display ajax loader
			beforeSend: function() {
				$("#chart").append("<div id='loader'></div>");
				$("#chart")[0].scrollIntoView(true);
			},
			success:function(data) {
		  		@{chart}(data);
			},
			//noContent remove loader
			error:function(q, err, ex) {
				$("#chart").html("");
			}
		});
	}
});
function displaySave() {
	var svg = $("svg");
	//if no chart
	if(svg.length < 1) {
		displayError("@Localize.get("err.noChart")");
	} else {
		svg.attr({ version: '1.1' , xmlns:"http://www.w3.org/2000/svg"});
		//the pop up container
		$("body").append("<div id='message'><div><span>@Localize.get("charts.save") @Localize.get("charts." + chart)</span>"
			+ "<span id=\"download\">@Localize.get("charts.download")</span><span id=\"abort\">@Localize.get("charts.abort")</span></div></div>");
		//the form
		var form = $(document.createElement("form")) //.wrap(document.createElement("p"))
			.insertAfter("#message span:first")
			.attr("action", "/downloadChart")
			.attr("method", "POST")
			.attr("name", "download")
		//the file name
		$(document.createElement("input")).appendTo(form)
			.attr("type", "text")
			.attr("name", "name")
			.attr("placeholder", "@Localize.get("charts.optional")");
		//the format
		$(document.createElement("select")).appendTo(form)
			.append("<option>svg</option><option>png</option>")
			.attr("type", "text")
			.attr("name", "format");
		//the image data
		$(document.createElement("input")).appendTo(form)
			.attr("type", "text")
			.attr("name", "svg")
			.attr("value", encodeURI(svg.parent().html()))
			.hide();
		//download button
		$("#download").click(function() {
			form.submit();
			$(this).parents("#message").remove();
		});
		//abort button
		$("#abort").click(function() {
			$(this).parents("#message").remove();
		});
		$("#message").find("#download").focus();
	}
}